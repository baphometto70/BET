<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mercati Estesi - BET Dashboard</title>
    <style>
      :root {
        --bg-color: #fcfcfc;
        --panel-bg-color: #ffffff;
        --text-color: #333333;
        --header-color: #1a1a1a;
        --subtle-text-color: #777777;
        --border-color: #e8e8e8;
        --accent-color: #5a7d9a;
        --accent-color-hover: #4a6a80;
        --success-color: #4CAF50;
        --warning-color: #FFC107;
        --danger-color: #EF5350;
        --shadow-color: rgba(0, 0, 0, 0.03);
        --fire-color: #ff6b35;
        --gold-color: #f7b731;
      }

      * { box-sizing: border-box; }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 2rem;
        font-size: 16px;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
      }

      header h1 {
        margin: 0;
        color: var(--header-color);
        font-size: 2rem;
        font-weight: 600;
      }

      .nav-links {
        display: flex;
        gap: 1.5rem;
      }

      .nav-links a {
        color: var(--accent-color);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      .nav-links a:hover {
        color: var(--accent-color-hover);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--panel-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px var(--shadow-color);
      }

      .stat-card h3 {
        margin: 0 0 0.5rem;
        font-size: 0.9rem;
        color: var(--subtle-text-color);
        text-transform: uppercase;
        font-weight: 500;
      }

      .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--header-color);
      }

      .stat-card .value.good {
        color: var(--success-color);
      }

      .panel {
        background: var(--panel-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px var(--shadow-color);
        overflow: hidden;
      }

      .panel-header {
        padding: 1.2rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: #fafafa;
      }

      .panel-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--header-color);
      }

      .panel-content {
        padding: 1.5rem;
      }

      .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .filter-form label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.3rem;
        color: var(--text-color);
      }

      .filter-form input,
      .filter-form select {
        width: 100%;
        padding: 0.7rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-color);
        font-size: 0.95rem;
      }

      .btn {
        display: inline-block;
        padding: 0.7rem 1.5rem;
        border-radius: 6px;
        border: none;
        background: var(--accent-color);
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        font-size: 0.95rem;
      }

      .btn:hover {
        background: var(--accent-color-hover);
      }

      .btn-success {
        background: var(--success-color);
      }

      .btn-success:hover {
        background: #45a049;
      }

      .category-section {
        margin-bottom: 2rem;
      }

      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: linear-gradient(135deg, var(--accent-color), var(--accent-color-hover));
        color: white;
        border-radius: 6px;
        margin-bottom: 1rem;
      }

      .category-header h3 {
        margin: 0;
        font-size: 1.2rem;
      }

      .category-header .badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
      }

      .bet-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }

      .bet-table th {
        background: #f5f5f5;
        padding: 0.8rem;
        text-align: left;
        font-weight: 600;
        color: var(--header-color);
        border-bottom: 2px solid var(--border-color);
        font-size: 0.9rem;
      }

      .bet-table td {
        padding: 0.8rem;
        border-bottom: 1px solid var(--border-color);
      }

      .bet-table tr:hover {
        background: #fafafa;
      }

      .confidence-high {
        color: var(--fire-color);
        font-weight: 700;
      }

      .confidence-medium {
        color: var(--gold-color);
        font-weight: 600;
      }

      .confidence-low {
        color: var(--subtle-text-color);
      }

      .prob-bar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .prob-bar-fill {
        flex: 1;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .prob-bar-fill-inner {
        height: 100%;
        background: linear-gradient(90deg, var(--success-color), var(--warning-color));
        transition: width 0.3s;
      }

      .prob-text {
        font-weight: 700;
        min-width: 55px;
        text-align: right;
      }

      .market-name {
        font-weight: 600;
        color: var(--header-color);
      }

      .match-info {
        color: var(--subtle-text-color);
        font-size: 0.9rem;
      }

      .value-positive {
        color: var(--success-color);
        font-weight: 600;
      }

      .value-negative {
        color: var(--danger-color);
      }

      .error-message {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 1rem;
        border-radius: 6px;
        color: #856404;
        margin-bottom: 1rem;
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--subtle-text-color);
      }

      .empty-state h3 {
        margin-bottom: 1rem;
        color: var(--header-color);
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }

        .bet-table {
          font-size: 0.85rem;
        }

        .bet-table th,
        .bet-table td {
          padding: 0.5rem;
        }
      }

      .top-picks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }

      .pick-card {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        background: white;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .pick-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-color);
      }

      .pick-card .rank {
        display: inline-block;
        background: var(--accent-color);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .pick-card .match {
        font-weight: 600;
        margin-bottom: 0.3rem;
        color: var(--header-color);
      }

      .pick-card .market {
        color: var(--accent-color);
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .pick-card .prob-large {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--fire-color);
        margin: 0.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üéØ Mercati Estesi - Sistema Avanzato</h1>
        <div class="nav-links">
          <a href="/">‚Üê Dashboard</a>
          <a href="/predictions-xg">xG Analysis</a>
          <a href="/proposta">Proposte</a>
        </div>
      </header>

      {% if error %}
      <div class="error-message">
        <strong>‚ö†Ô∏è Attenzione:</strong> {{ error }}
      </div>
      {% endif %}

      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Partite Analizzate</h3>
          <div class="value">{{ stats.matches_analyzed }}</div>
        </div>
        <div class="stat-card">
          <h3>Scommesse Totali</h3>
          <div class="value">{{ stats.total_bets }}</div>
        </div>
        <div class="stat-card">
          <h3>Scommesse Filtrate</h3>
          <div class="value good">{{ stats.filtered_bets }}</div>
        </div>
        <div class="stat-card">
          <h3>Probabilit√† Media</h3>
          <div class="value good">{{ stats.avg_prob }}%</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="panel">
        <div class="panel-header">
          <h2>‚öôÔ∏è Filtri e Generazione</h2>
        </div>
        <div class="panel-content">
          <form method="POST" action="/generate-extended" class="filter-form">
            <div>
              <label>Data</label>
              <input type="date" name="date" value="{{ selected_date }}" required />
            </div>
            <div>
              <label>Probabilit√† Minima</label>
              <input type="number" name="min_prob" value="0.55" step="0.05" min="0.1" max="0.99" />
            </div>
            <div>
              <label>Top N per Partita</label>
              <input type="number" name="top_n" value="15" min="5" max="50" />
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button type="submit" class="btn btn-success" style="width: 100%;">
                üöÄ Genera Predizioni Estese
              </button>
            </div>
          </form>

          <form method="GET" action="/extended-markets" class="filter-form" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <div>
              <label>Filtra per Data</label>
              <input type="date" name="date" value="{{ selected_date }}" />
            </div>
            <div>
              <label>Probabilit√† Minima (%)</label>
              <input type="number" name="min_prob" value="{{ min_prob * 100 }}" step="5" min="50" max="99" />
            </div>
            <div>
              <label>Max per Partita</label>
              <input type="number" name="max_per_match" value="{{ max_per_match }}" min="1" max="10" />
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button type="submit" class="btn" style="width: 100%;">
                üîç Applica Filtri
              </button>
            </div>
          </form>
        </div>
      </div>

      {% if top_picks %}
      <!-- Top 20 Best Picks -->
      <div class="panel">
        <div class="panel-header">
          <h2>üî• Top 20 Scommesse Consigliate</h2>
        </div>
        <div class="panel-content">
          <div class="top-picks-grid">
            {% for pick in top_picks[:20] %}
            <div class="pick-card">
              <span class="rank">#{{ loop.index }}</span>
              <div class="match">{{ pick.home[:20] }} - {{ pick.away[:20] }}</div>
              <div class="match-info" style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                {{ pick.league }} ‚Ä¢ ‚è∞ {{ pick.kickoff_time }}
              </div>
              <div class="market">{{ pick.market_name }} ({{ (pick.probability * 100)|round(1) }}%)</div>
              <div class="prob-large">{{ (pick.probability * 100)|round(1) }}%</div>
              <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                <span class="confidence-{{ pick.confidence }}">{{ pick.confidence.upper() }}</span>
                {% if pick.value %}
                <span class="value-positive">Value: +{{ (pick.value * 100)|round(1) }}%</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Categories -->
      {% for cat_name, cat_data in categories.items() %}
      <div class="panel category-section">
        <div class="category-header">
          <h3>{{ cat_name }}</h3>
          <div class="badge">{{ cat_data.count }} scommesse ‚Ä¢ Prob Media: {{ cat_data.avg_prob }}%</div>
        </div>
        <div class="panel-content">
          <table class="bet-table">
            <thead>
              <tr>
                <th>Partita</th>
                <th>Orario</th>
                <th>Mercato</th>
                <th>Probabilit√†</th>
                <th>Value</th>
                <th>Confidence</th>
              </tr>
            </thead>
            <tbody>
              {% for bet in cat_data.bets %}
              <tr>
                <td>
                  <div class="market-name">{{ bet.home[:25] }} - {{ bet.away[:25] }}</div>
                  <div class="match-info">{{ bet.league }}</div>
                </td>
                <td>
                  <strong style="color: var(--accent-color);">‚è∞ {{ bet.kickoff_time }}</strong>
                </td>
                <td>
                  <strong>{{ bet.market_name }} ({{ (bet.probability * 100)|round(1) }}%)</strong>
                </td>
                <td>
                  <div class="prob-bar">
                    <div class="prob-bar-fill">
                      <div class="prob-bar-fill-inner" style="width: {{ (bet.probability * 100)|round(0) }}%;"></div>
                    </div>
                    <span class="prob-text">{{ (bet.probability * 100)|round(1) }}%</span>
                  </div>
                </td>
                <td>
                  {% if bet.value %}
                  <span class="value-positive">+{{ (bet.value * 100)|round(1) }}%</span>
                  {% else %}
                  <span>-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="confidence-{{ bet.confidence }}">
                    {% if bet.confidence == 'high' %}üî•üî•{% elif bet.confidence == 'medium' %}üî•{% else %}‚óã{% endif %}
                    {{ bet.confidence.upper() }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}

      {% if not categories and not error %}
      <div class="empty-state">
        <h3>üìä Nessuna Scommessa Disponibile</h3>
        <p>Genera predizioni estese usando il form sopra per vedere i risultati.</p>
        <p>Il sistema generer√† automaticamente 200+ scommesse su 6 categorie di mercati.</p>
      </div>
      {% endif %}

      <div class="panel">
        <div class="panel-header">
          <h2>‚ÑπÔ∏è Informazioni Mercati Estesi</h2>
        </div>
        <div class="panel-content">
          <h3>Categorie Disponibili:</h3>
          <ul>
            <li><strong>Over/Under</strong>: Multiple linee (0.5, 1.5, 2.5, 3.5, 4.5, 5.5 goals)</li>
            <li><strong>Team Totals</strong>: Over/Under per singola squadra (Home/Away)</li>
            <li><strong>Doppia Chance (DC)</strong>: 1X, X2, 12 - maggiore sicurezza</li>
            <li><strong>Multigol</strong>: Intervalli di gol (1-2, 1-3, 2-3, 2-4, 2-5, 3-5)</li>
            <li><strong>Goal/No Goal</strong>: GG (entrambe segnano), NG (almeno una non segna)</li>
            <li><strong>Combo Markets</strong>: Combinazioni (DC+GG, DC+OU, ecc.)</li>
          </ul>

          <h3 style="margin-top: 1.5rem;">Strategia Consigliata:</h3>
          <p><strong>Sistema Parziale (Ottimale)</strong>: Gioca le Top 20 scommesse con sistema ridotto 16/20 (richiedi 16 vincenti su 20).</p>
          <p>Con probabilit√† medie del 95%, hai ~50% di successo e ROI atteso +20-30%.</p>
        </div>
      </div>
    </div>
  </body>
</html>
